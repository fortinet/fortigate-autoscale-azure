{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "3.3.0.0",
    "parameters": {
        "ResourceNamePrefix": {
            "type": "String",
            "metadata": {
                "description": "'ResourceNamePrefix' value found in the input of the old deployment template."
            }
        },
        "UpgradeIteration": {
            "type": "Int",
            "defaultValue": 2,
            "minValue": 2,
            "metadata": {
                "description": "The upgrade iteration number, starting from 2. Increase it by 1 when starts a new deployment if any previous upgrade iteration has failed. The iteration number can be found as 'upgradeIteration' in the output of any upgrade deployment."
            }
        },
        "VNetResourceGroupName": {
            "type": "String",
            "metadata": {
                "description": "'VNetResourceGroupName' value found in the output of the old deployment template."
            }
        }
    },
    "variables": {
        "autoscaleSettingsNameBYOL": "[concat(parameters('ResourceNamePrefix'), '-autoscalesettings-', variables('vmssNameBYOL'))]",
        "autoscaleSettingsNameBYOLOld": "[concat(parameters('ResourceNamePrefix'), '-autoscalesettings-byol')]",
        "autoscaleSettingsNamePAYG": "[concat(parameters('ResourceNamePrefix'), '-autoscalesettings-', variables('vmssNamePAYG'))]",
        "autoscaleSettingsNamePAYGOld": "[concat(parameters('ResourceNamePrefix'), '-autoscalesettings-payg')]",
        "cmdDeleteAutoscaleAllOld": "[concat('az account set -s ', subscription().subscriptionId, ';', variables('cmdDeleteFunctionAppAllOld'), variables('cmdDeleteVMSSAllOld'), variables('cmdDeleteDatabaseAllOld'))]",
        "cmdDeleteAutoscaleAllUI": "[concat('az account set -s ', subscription().subscriptionId, ';', variables('cmdDeleteFunctionAppAllUI'), variables('cmdDeleteVMSSAllUI'), variables('cmdDeleteDatabaseAllUI'), variables('cmdDeleteKeyVaultUI'), variables('cmdDeleteStorageAccountUI'))]",
        "cmdDeleteAutoscaleSettingsOld": "[concat('az monitor autoscale delete', ' -g ', variables('vNetResourceGroupName'), ' -n ', variables('autoscaleSettingsNameBYOLOld'), ';', 'az monitor autoscale delete -g ', variables('vNetResourceGroupName'), ' -n ', variables('autoscaleSettingsNamePAYGOld'), ';')]",
        "cmdDeleteAutoscaleSettingsUI": "[concat('az monitor autoscale delete', ' -g ', variables('vNetResourceGroupName'), ' -n ', variables('autoscaleSettingsNameBYOL'), ';', 'az monitor autoscale delete -g ', variables('vNetResourceGroupName'), ' -n ', variables('autoscaleSettingsNamePAYG'), ';')]",
        "cmdDeleteDatabaseAccountOld": "[concat('az cosmosdb delete -y -g ', resourceGroup().name, ' -n ', variables('databaseAccountNameOld'), ';')]",
        "cmdDeleteDatabaseAccountUI": "[concat('az cosmosdb delete -y -g ', resourceGroup().name, ' -n ', variables('databaseAccountName'), ';')]",
        "cmdDeleteDatabaseAllOld": "[concat('az account set -s ', subscription().subscriptionId, ';', variables('cmdDeleteDatabaseOld'), variables('cmdDeleteDatabaseAccountOld'))]",
        "cmdDeleteDatabaseAllUI": "[concat('az account set -s ', subscription().subscriptionId, ';', variables('cmdDeleteDatabaseUI'), variables('cmdDeleteDatabaseAccountUI'))]",
        "cmdDeleteDatabaseOld": "[concat('az cosmosdb sql database delete -y -g ', resourceGroup().name, ' -a ', variables('databaseAccountNameOld'), ' -n ', variables('databaseName'), ';')]",
        "cmdDeleteDatabaseUI": "[concat('az cosmosdb sql database delete -y -g ', resourceGroup().name, ' -a ', variables('databaseAccountName'), ' -n ', variables('databaseName'), ';')]",
        "cmdDeleteFunctionAppAllOld": "[concat(variables('cmdDeleteFunctionAppInsightsOld'),variables('cmdDeleteFunctionAppSiteOld'),variables('cmdDeleteFunctionAppServerFarmOld'))]",
        "cmdDeleteFunctionAppAllUI": "[concat('az account set -s ', subscription().subscriptionId, ';', variables('cmdDeleteFunctionAppInsightsUI'), variables('cmdDeleteFunctionAppSiteUI'), variables('cmdDeleteFunctionAppServerFarmUI'))]",
        "cmdDeleteFunctionAppInsightsOld": "[concat('az monitor app-insights component delete', ' -a ', variables('functionAppNameOld'), ' -g ', resourceGroup().name, ';')]",
        "cmdDeleteFunctionAppInsightsUI": "[concat('az monitor app-insights component delete', ' -a ', variables('functionAppInsightName'), ' -g ', resourceGroup().name, ';')]",
        "cmdDeleteFunctionAppServerFarmOld": "[concat('az appservice plan delete -y', ' -n ', variables('hostingPlanNameOld'), ' -g ', resourceGroup().name, ';')]",
        "cmdDeleteFunctionAppServerFarmUI": "[concat('az appservice plan delete -y', ' -n ', variables('hostingPlanName'), ' -g ', resourceGroup().name, ';')]",
        "cmdDeleteFunctionAppSiteOld": "[concat('az webapp delete', ' -n ', variables('functionAppNameOld'), ' -g ', resourceGroup().name, ';')]",
        "cmdDeleteFunctionAppSiteUI": "[concat('az webapp delete', ' -n ', variables('functionAppName'), ' -g ', resourceGroup().name, ';')]",
        "cmdDeleteKeyVaultUI": "[concat('az keyvault delete -n ', variables('keyVaultName'), ' -g ', resourceGroup().name, ';')]",
        "cmdDeleteStorageAccountUI": "[concat('az storage account delete -yn ', variables('storageAccountName'), ' -g ', resourceGroup().name, ';')]",
        "cmdDeleteVMSSAllOld": "[concat(variables('cmdDeleteAutoscaleSettingsOld'), variables('cmdDeleteVMSSOld'))]",
        "cmdDeleteVMSSAllUI": "[concat('az account set -s ', subscription().subscriptionId, ';', variables('cmdDeleteAutoscaleSettingsUI'), variables('cmdDeleteVMSSUI'))]",
        "cmdDeleteVMSSOld": "[concat('az vmss delete', ' -g ', variables('vNetResourceGroupName'),' -n ', variables('vmssNameBYOLOld'), ';', 'az vmss delete -g ', variables('vNetResourceGroupName'),' -n ', variables('vmssNamePAYGOld'), ';')]",
        "cmdDeleteVMSSUI": "[concat('az vmss delete', ' -g ', variables('vNetResourceGroupName'),' -n ', variables('vmssNameBYOL'), ';', 'az vmss delete -g ', variables('vNetResourceGroupName'),' -n ', variables('vmssNamePAYG'), ';')]",
        "databaseAccountName": "[concat(toLower(variables('uniqueResourceNamePrefix')),'dba', variables('upgradeIterationNumber'))]",
        "databaseAccountNameOld": "[concat(toLower(variables('uniqueResourceNamePrefix')),'dba001')]",
        "databaseName": "FortiGateAutoscale",
        "functionAppInsightName": "[concat(variables('functionAppName'),'-insights')]",
        "functionAppName": "[concat(variables('uniqueResourceNamePrefix'),'funcapp', variables('upgradeIterationNumber'))]",
        "functionAppNameOld": "[concat(variables('uniqueResourceNamePrefix'),'funcapp')]",
        "hostingPlanName": "[concat(variables('functionAppName'),'-service-plan')]",
        "hostingPlanNameOld": "[concat(variables('functionAppNameOld'),'-service-plan')]",
        "keyVaultName": "[concat(toLower(variables('uniqueResourceNamePrefix')),'kv', variables('upgradeIterationNumber'))]",
        "storageAccountName": "[concat(toLower(variables('uniqueResourceNamePrefix')),'sta', variables('upgradeIterationNumber'))]",
        "uniqueId": "[take(uniquestring(resourceGroup().id), 8)]",
        "uniqueResourceNamePrefix": "[concat(parameters('ResourceNamePrefix'), variables('uniqueId'))]",
        "upgradeIterationNumber": "[padLeft(parameters('UpgradeIteration'),3,'0')]",
        "vNetResourceGroupName": "[parameters('VNetResourceGroupName')]",
        "vmssNameBYOL": "[concat(parameters('ResourceNamePrefix'), 'byol', variables('upgradeIterationNumber'))]",
        "vmssNameBYOLOld": "[concat(parameters('ResourceNamePrefix'), 'byol')]",
        "vmssNamePAYG": "[concat(parameters('ResourceNamePrefix'), 'payg', variables('upgradeIterationNumber'))]",
        "vmssNamePAYGOld": "[concat(parameters('ResourceNamePrefix'), 'payg')]"
    },
    "resources": [],
    "outputs": {
        "cleanUpOldComponentCmdDeleteAllInOne": {
            "type": "String",
            "value": "[variables('cmdDeleteAutoscaleAllOld')]"
        },
        "cleanUpOldComponentCmdDeleteDatabaseAccount": {
            "type": "String",
            "value": "[variables('cmdDeleteDatabaseAllOld')]"
        },
        "cleanUpOldComponentCmdDeleteFunctionApp": {
            "type": "String",
            "value": "[variables('cmdDeleteFunctionAppAllOld')]"
        },
        "cleanUpOldComponentCmdDeleteVMSS": {
            "type": "String",
            "value": "[variables('cmdDeleteVMSSAllOld')]"
        },
        "upgradeIterationCmdDeleteAllInOne": {
            "type": "String",
            "value": "[variables('cmdDeleteAutoscaleAllUI')]"
        },
        "upgradeIterationCmdDeleteDatabaseAccount": {
            "type": "String",
            "value": "[variables('cmdDeleteDatabaseAllUI')]"
        },
        "upgradeIterationCmdDeleteFunctionApp": {
            "type": "String",
            "value": "[variables('cmdDeleteFunctionAppAllUI')]"
        },
        "upgradeIterationCmdDeleteKeyVault": {
            "type": "String",
            "value": "[variables('cmdDeleteKeyVaultUI')]"
        },
        "upgradeIterationCmdDeleteStorageAccount": {
            "type": "String",
            "value": "[variables('cmdDeleteStorageAccountUI')]"
        },
        "upgradeIterationCmdDeleteVMSS": {
            "type": "String",
            "value": "[variables('cmdDeleteVMSSAllUI')]"
        }
    }
}
